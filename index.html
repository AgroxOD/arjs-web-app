<!DOCTYPE html>
<html>
  <head>
    <title>AR.js Web App - Optimized</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      .menu-toggle {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        padding: 10px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
      }
      .menu-panel {
        display: none;
        flex-direction: column;
        position: fixed;
        top: 60px;
        left: 10px;
        width: 260px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .menu-panel.active {
        display: flex;
        opacity: 1;
        transform: translateY(0);
      }
      .menu-panel label {
        margin-bottom: 10px;
        font-size: 0.95em;
        display: flex;
        flex-direction: column;
      }
      .menu-panel input[type="range"],
      .menu-panel input[type="number"],
      .menu-panel select {
        margin-top: 4px;
        height: 28px;
        font-size: 1em;
      }
      .menu-panel button {
        margin-top: 10px;
        padding: 6px;
        font-size: 1em;
        border-radius: 6px;
        border: none;
        background-color: #2196F3;
        color: white;
        cursor: pointer;
      }
      #cameraWarning {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffdddd;
        color: #900;
        padding: 10px;
        text-align: center;
        z-index: 1000;
        font-size: 14px;
      }
      #cameraWarning button {
        margin-top: 5px;
        padding: 5px 10px;
        background: #c00;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button class="menu-toggle" onclick="toggleMenu()">Меню</button>
    <div class="menu-panel" id="menuPanel">
      <label>Модель:
        <select id="modelSelector">
          <option value="homer.glb">Homer</option>
          <option value="model2.glb">Model 2</option>
          <option value="model3.glb" selected>Model 3</option>
        </select>
      </label>
      <label>Масштаб:
        <input type="range" id="scaleSlider" min="0.1" max="5" step="0.1" value="0.5">
        <input type="number" id="scaleInput" min="0.1" max="5" step="0.1" value="0.5">
      </label>
      <label>Поворот X:
        <input type="range" id="rotationXSlider" min="-180" max="180" step="5" value="-90">
        <input type="number" id="rotationXInput" min="-180" max="180" step="5" value="-90">
      </label>
      <label>Поворот Y:
        <input type="range" id="rotationYSlider" min="0" max="360" step="5" value="180">
        <input type="number" id="rotationYInput" min="0" max="360" step="5" value="180">
      </label>
      <label>Позиция Z:
        <input type="range" id="positionZSlider" min="-5" max="5" step="0.1" value="0">
        <input type="number" id="positionZInput" min="-5" max="5" step="0.1" value="0">
      </label>
      <button id="resetButton">&#x21bb; Сброс</button>
    </div>

    <div id="cameraWarning">
      ⚠️ Камера не активна. Проверьте разрешения браузера.<br>
      <button onclick="location.reload()">Обновить страницу</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">
      <a-marker preset="hiro" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
        <a-entity id="arModel"
                  gltf-model="model3.glb"
                  scale="0.5 0.5 0.5"
                  position="0 0 0"
                  rotation="-90 0 0">
        </a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const $ = (id) => document.getElementById(id);
      const arModel = $('arModel');

      const selector = $('modelSelector');
      const scaleSlider = $('scaleSlider');
      const scaleInput = $('scaleInput');
      const rotationXSlider = $('rotationXSlider');
      const rotationYSlider = $('rotationYSlider');
      const rotationXInput = $('rotationXInput');
      const rotationYInput = $('rotationYInput');
      const positionZSlider = $('positionZSlider');
      const positionZInput = $('positionZInput');
      const resetButton = $('resetButton');

      function toggleMenu() {
        $('menuPanel').classList.toggle('active');
      }

      selector.addEventListener('change', (e) => {
        arModel.setAttribute('gltf-model', e.target.value);
      });

      function syncScale(val) {
        scaleSlider.value = val;
        scaleInput.value = val;
        arModel.setAttribute('scale', `${val} ${val} ${val}`);
      }

      scaleSlider.addEventListener('input', (e) => syncScale(e.target.value));
      scaleInput.addEventListener('input', (e) => syncScale(e.target.value));

      function syncRotation() {
        const x = rotationXSlider.value;
        const y = rotationYSlider.value;
        rotationXInput.value = x;
        rotationYInput.value = y;
        arModel.setAttribute('rotation', `${x} ${y} 0`);
      }

      [rotationXSlider, rotationXInput].forEach(el => el.addEventListener('input', syncRotation));
      [rotationYSlider, rotationYInput].forEach(el => el.addEventListener('input', syncRotation));

      function syncPositionZ(val) {
        positionZSlider.value = val;
        positionZInput.value = val;
        const pos = arModel.getAttribute('position');
        arModel.setAttribute('position', `${pos.x} ${pos.y} ${val}`);
      }

      positionZSlider.addEventListener('input', (e) => syncPositionZ(e.target.value));
      positionZInput.addEventListener('input', (e) => syncPositionZ(e.target.value));

      resetButton.addEventListener('click', () => {
        const model = selector.value;
        syncScale(0.5);
        rotationXSlider.value = rotationXInput.value = -90;
        rotationYSlider.value = rotationYInput.value = 180;
        positionZSlider.value = positionZInput.value = 0;
        arModel.setAttribute('gltf-model', model);
        arModel.setAttribute('rotation', `-90 180 0`);
        arModel.setAttribute('position', `0 0 0`);
      });

      window.addEventListener('load', () => {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            $('cameraWarning').style.display = 'none';
            stream.getTracks().forEach(track => track.stop());
          })
          .catch(() => {
            $('cameraWarning').style.display = 'block';
          });
      });
    </script>
  <div id="loadingDialog" style="display:flex;justify-content:center;align-items:center;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);color:white;z-index:2000;font-size:1.2em;flex-direction:column;">
  <div>Загрузка модели: <span id="loadingProgress">0%</span></div>
</div>

<script>
  const loadingDialog = document.getElementById('loadingDialog');
  const loadingProgress = document.getElementById('loadingProgress');

  const modelEl = document.querySelector('#arModel');

  modelEl.addEventListener('model-progress', (evt) => {
    const percent = Math.floor(evt.detail.loaded / evt.detail.total * 100);
    loadingProgress.textContent = `${percent}%`;
  });

  modelEl.addEventListener('model-loaded', () => {
    loadingProgress.textContent = '100%';
    setTimeout(() => {
      loadingDialog.style.display = 'none';
    }, 500);
  });
</script>
</body>
</html>
